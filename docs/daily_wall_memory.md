# Daily Wall — Memory Block (baseline 2025-09-06)

## 1) Цель и исходное ТЗ
Кроссплатформенный ежедневник (Windows + Android) в виде «стены-плитки» по дням:
- Каждый календарный день — отдельная стена (grid). Новые сутки → новая стена.
- Быстро добавляю заметки/ссылки/изображения/файлы (pdf/doc/xls/txt).
- На плитках показываются миниатюры/превью; по нажатию — полноэкранный просмотр внутри приложения, закрытие кнопкой «назад»/по клику мимо.
- Навигация: свайп/стрелки ◀ ▶ + выбор даты (по нажатию на дату вверху).
- Поиск по всем дням.
- Редактор форматирования: 3 размера текста (заголовок, основной, «примечание» курсивом), **Bold**, *Italic*, Underline, выравнивание слева/по центру/справа.
- Безопасность (V1): доступ по PIN, синхронизация между устройствами с E2EE, локальное шифрованное хранилище, спаривание смартфона и ПК через QR (messenger-style).

## 2) Текущее состояние (MVP срез)
**Платформы:** Windows запущена; Android — следующая задача (тот же код Flutter).

**Тема/вид:** следование системной теме; debug-баннер отключён.

**Главный экран (день)** — `lib/wall/day_wall_page.dart`:
- Дата по центру в AppBar; нажатие по дате открывает календарь. Стрелки переходят на предыдущий/следующий день.
- Плитки показывают содержимое (текст/ссылки/миниатюры); **текст можно выделять** (копирование фрагментов).
- Заголовки на плитках выключены — отображаем просто текст или активную ссылку (визуально H2-размер).
- Кнопка «вставить из буфера» (иконка без подписи) — сразу добавляет содержимое **без открытия редактора**. Поддержаны текст/ссылки/изображения.
- Миниатюры изображений: **BoxFit.contain** (ничего не обрезается). По нажатию — полноэкранный просмотр, закрытие по клику в фон или по крестику.

**Редактор** — `lib/wall/widgets/note_editor.dart` (на `flutter_quill 11.4.2`):
- WYSIWYG-ввод (живой предпросмотр прямо в поле ввода).
- Панель: Bold / Italic / Underline; выравнивание Left/Center/Right; размеры: Title(H1) / Subtitle(H2) / Body; «малый курсив» для примечаний.
- Горячие клавиши:  
  `Ctrl+B / Ctrl+I / Ctrl+U`, `Ctrl+L / Ctrl+E / Ctrl+R`, `Ctrl+1 / Ctrl+2 / Ctrl+0`.  
  Enter — создать запись; Alt+Enter — перенос строки.  
  Формат по умолчанию: основной текст, **центр**.

**Поиск** — `lib/wall/search_page.dart`:
- «Живой» поиск с дебаунсом (обновляется при вводе).
- Превью формируются из Quill-Delta → плейн-текст; подсветка совпадений нейтральным фоном, **без унаследованных украшений**.
- Тап по результату открывает соответствующий день.

**Просмотр изображений** — `lib/wall/widgets/image_preview.dart`:
- Полноэкранный диалог/оверлей, закрытие по нажатию вне или по кнопке.

**Убрано по решению:**
- Теги / фильтры / сортировки — **не нужны** для ежедневника.
- Редактирование плитки по нажатию — **отключено**, только через явную кнопку «Редактировать».

## 3) Структура проекта (ключевые файлы)
```
lib/
  main.dart
  wall/
    day_wall_page.dart
    search_page.dart
    data/
      wall_store.dart
    widgets/
      note_editor.dart
      image_preview.dart
```
`WallStore` даёт высокоуровневый доступ: `byDay(DateTime)` и `search(String)` → `List<WallEntry>`.  
`WallEntry`: `day: DateTime`, `body: String (Quill Delta JSON или plain)`, опционально: ссылки/изображения.

## 4) Зависимости и версии (снимок)
- **Flutter**: 3.35.2 stable (Dart 3.5.x).  
  `environment` (в `pubspec.yaml`):
  ```yaml
  environment:
    sdk: ">=3.5.0 <4.0.0"
    flutter: ">=3.35.0"
  ```
- **pubspec (прямые):**
  - `flutter_quill: ^11.4.2`
  - `url_launcher: ^6.3.0`
  - `path_provider: ^2.1.4`
  - `path: ^1.9.0`
  - `desktop_drop: ^0.5.0` (опционально; сейчас не обязательно)
  - `cupertino_icons: ^1.0.8`
- **dev:** `flutter_lints: ^6.0.0`, `flutter_test` (sdk).  
Транзитивные (`characters`, `material_color_utilities`, `meta`, `test_api`) пинятся SDK и обновятся с новым Flutter/Dart.

## 5) UX-правила, которые нужно сохранять
- Нет тегов/фильтров/сортировок.  
- Редактирование — **только** по кнопке «Редактировать».  
- Текст на плитках должен выделяться.  
- Дата по центру; календарь по нажатию на дату; стрелки ◀ ▶.  
- Кнопка «вставить из буфера» (иконка) — добавляет сразу, без редактора.  
- Миниатюры изображений не обрезаются (contain); полноэкранный просмотр с закрытием по фону/крестику.

## 6) Беклог (следующие шаги)
- **Android-сборка** (доступ к файлам/доля «Share»/storage-пермишены).
- **Вложения-файлы**: pdf/doc/xls/txt — миниатюры (pdf-страница 1), быстрый просмотр внутри приложения.
- **FTS5** (SQLite) для полнотекстового поиска, инкрементальные обновления индекса.
- **PIN-лок** (автоблок при свёртывании/простаивании).
- **E2EE-синхронизация** и **QR-паринг** устройств:
  - PIN → Argon2id, хранится только хэш; Device Key (DEK) обёрнут в OS-хранилище (Android Keystore / Windows DPAPI).
  - Паринг X25519 (ECDH), HKDF; сервер хранит только шифротексты (никаких ключей/открытого текста).
  - Частичный синк по датам (загружаем нужные стены).
- Расчистка депрекейтов Material3: `withOpacity` → `withValues(alpha: …)`, `surfaceVariant` → `surfaceContainerHighest`.

## 7) Команды сборки (Windows)
```powershell
flutter pub get
flutter run -d windows -t .\lib\main.dart
```
(При апгрейде SDK на Windows закрывать IDE и убивать `dart.exe`; чистка `D:\Libraries\Flutterin\cache\dart-sdk` помогает устранить блокировки.)

## 8) Git-процесс и «память» между чатами
- После **каждой полноценной фичи**:
  1) Создаём **новый memory-блок** (коротко: что сделали, какие файлы, UX-изменения, миграции/команды).
  2) Фиксируем стабильную точку:
     ```bash
     git add -A
     git commit -m "feat: <feature> (stable)"
     git tag vX.Y.Z-dw-<feature>
     git push && git push --tags
     ```
  3) Добавляем этот mini-блок в `docs/daily_wall_memory.md` (append).

**Инструкция для будущих чатов:**  
В начале нового чата вставляй последний memory-блок (этот документ сверху) + текущие `flutter --version` / `dart --version` и `pubspec.yaml`. При запросе новой «крупной» функции — по завершении всегда проси меня сформировать **новый блок памяти** и предложить создать **промежуточную версию/тег** в Git.

---

**Примечания:**
- Захват `Ctrl+V` на главной стене намеренно ограничен (чтобы не всплывал редактор случайно). Быстрая вставка — через иконку FAB; в редакторе вставка работает стандартно.
- Миниатюры изображений — `contain`, полноэкранный просмотр — оверлей.

**Конец memory-блока.
Daily Wall — Memory Block: Android bring-up (2025-09-07)

Що зроблено

Мінімальний запуск на Android (емулятор). Код не змінювався.

Перевірено збірку/debug-run, апка стартує, hot reload доступний (епізодичний обрив VM Service можливий на деяких AVD).

Версії / середовище

Flutter 3.35.3, Dart 3.9.2 (stable).

Android SDK: встановлено Android SDK Platform 33, NDK r27.0.12077973, CMake 3.22.1 (auto-install під час першого запуску).

Емулятор: sdk gphone64 x86_64 (API 33/Google APIs).

Поточний applicationId: com.example.daily_wall.

Daily Wall — Memory Block: Android bring-up + configs (2025-09-07)

Що зроблено: Android bring-up; applicationId=com.quantos.dailywall; compileSdk/targetSdk=36; Java/Kotlin=17; маніфести оновлено; APK запускається на емуляторі.

Файли: android/app/build.gradle.kts, android/app/src/*/AndroidManifest.xml, android/app/src/main/kotlin/com/quantos/dailywall/MainActivity.kt.

Команди: flutter clean && flutter pub get && flutter run -d <deviceId> -t lib/main.dart.

Нотатки: попередження про Java 8 — від сторонніх залежностей, не критично.

2025-09-07 — Link previews + Android bring-up polish

Что сделали

Android bring-up:

applicationId → com.quantos.dailywall.

compileSdk = 36, Java/Kotlin 17 (совместимость и toolchain).

Добавили INTERNET (для загрузки превью/фавиконок).

App Gradle на Kotlin DSL (android/app/build.gradle.kts).

Плитки / UX:

Кнопки действий (✏️ редактировать, 🗑 удалить, 📋 копировать) — вертикально справа, без надписей.

Плитки по высоте по содержимому (без «bottom overflow»).

Миниатюры изображений BoxFit.contain; полноэкранный просмотр (тап по фону/крестик).

FAB «плюс» (добавить) и малый FAB «вставить из буфера» (мгновенная вставка — без редактора).

Ссылки и превью (новое):

Если запись содержит URL — рендерим карточку-превью:

выбираем лучшую миниатюру:

прямая картинка (по расширению или HEAD Content-Type: image/*),

og:image / twitter:image,

первая <img src|srcset> на странице,

favicon (из <link rel=icon> или https://www.google.com/s2/favicons?...) — как фоллбек.

заголовок: og:title → twitter:title → <title> → host.

тап по карточке открывает URL во внешнем браузере.

В обычном тексте все URL теперь кликабельны ( SelectableText.rich + TapGestureRecognizer ).

Share intake:

Принятые через Android «Поделиться» файлы сохраняются в
AppDocDir/daily_wall/media/…; ссылки на локальные изображения — local://….

Текст/URL добавляются на сегодняшнюю стену.

Изменённые/добавленные файлы

lib/wall/widgets/entry_view.dart — карточки превью, кликабельные текстовые ссылки, полноэкранный просмотр изображений.

lib/share/share_intake.dart — обработка Android Share (текст/URL/изображения), сохранение медиа.

lib/wall/day_wall_page.dart — раскладка плиток, вертикальная панель действий, фиксы overflow.

android/app/src/main/AndroidManifest.xml — <uses-permission android:name="android.permission.INTERNET" />.

android/app/build.gradle.kts — applicationId, compileSdk(36), Java/Kotlin 17.

(pubspec) зависимости: http, html (для загрузки метаданных/парсинга), url_launcher уже был.

UX-заметки (сохраняем правила)

Заголовков на карточках нет — отображаем только содержимое (H2-размер).

Миниатюры не обрезаются (contain).

Редактирование записи — только по кнопке «Редактировать».

Поиск — «живой», с подсветкой.

Вставка из буфера — малый FAB, без редактора.

Команды сборки (Windows)

flutter pub get
flutter run -d windows -t .\lib\main.dart
# Android
flutter run -d emulator-5554 -t .\lib\main.dart


Ограничения

Для некоторых страниц без og:image/<img> и с закрытым HEAD карточка покажет только favicon — это ожидаемый фоллбек.


